syntax = "proto3";

package noble.dollar.vaults.v2;

import "amino/amino.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/timestamp.proto";

option go_package = "dollar.noble.xyz/v3/types/vaults/v2";

// NOBLE DOLLAR V2 VAULT SYSTEM - YIELD-TRACKING ACCOUNTING
//
// This package defines the V2 vault system that uses direct yield tracking
// for explicit yield accounting and improved transparency.
//
// Key features:
// - Direct yield tracking per user position
// - Explicit yield accrual accounting
// - Exit queues for withdrawals
// - User-controlled yield preferences
// - Clean separation from legacy V1 system
//
// Migration approach: Users must withdraw from V1 and deposit into V2

// UserPosition represents a user's position in the V2 yield-tracking vault system
message UserPosition {
  // Current deposit amount (principal)
  string deposit_amount = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Accrued yield on the position
  string accrued_yield = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Timestamp of first deposit
  google.protobuf.Timestamp first_deposit_time = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Timestamp of last deposit/withdrawal
  google.protobuf.Timestamp last_activity_time = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Whether user wants to receive yield (vs contributing to fee pool)
  bool receive_yield = 5;

  // Deposit amount pending withdrawal
  string deposit_pending_withdrawal = 6 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Yield amount pending withdrawal
  string yield_pending_withdrawal = 7 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total amount pending withdrawal (deposit + yield)
  string total_pending_withdrawal = 8 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Number of active withdrawal requests
  int32 active_withdrawal_requests = 9;

  // Position ID (unique per user)
  uint64 position_id = 10;
}

// AccountingSnapshot represents a pending update to a user position during accounting.
// These snapshots are used to stage all accounting changes before atomically committing
// them when the accounting session completes. This ensures consistency even if accounting
// is performed across multiple message invocations.
message AccountingSnapshot {
  // User address
  string user = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Position ID
  uint64 position_id = 2;

  // New deposit amount after accounting
  string deposit_amount = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // New accrued yield after accounting
  string accrued_yield = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // NAV value used for this snapshot
  string accounting_nav = 5 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Block height when this snapshot was created
  int64 created_at_height = 6;
}

// WithdrawalRequest represents a pending withdrawal request
message WithdrawalRequest {
  // Unique request ID
  string request_id = 1;

  // Address of the account that created the request
  string requester = 2 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Amount to withdraw (including yield)
  string withdraw_amount = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // When the withdrawal was requested
  google.protobuf.Timestamp request_time = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // When the withdrawal can be processed
  google.protobuf.Timestamp unlock_time = 5 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Current status of the withdrawal request
  WithdrawalRequestStatus status = 6;

  // Estimated amount to receive (calculated at request time)
  string estimated_amount = 7 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Block height when request was made
  int64 request_block_height = 8;

  // Position ID this withdrawal is from
  uint64 position_id = 9;

  // Amount withdrawn from accrued yield
  string yield_amount = 10 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Amount withdrawn from principal deposits
  string principal_amount = 11 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// WithdrawalRequestStatus represents the status of a withdrawal request
enum WithdrawalRequestStatus {
  option (gogoproto.goproto_enum_prefix) = false;

  // Request is pending (waiting for unlock time)
  WITHDRAWAL_REQUEST_STATUS_PENDING = 0;
  // Request is ready to be processed
  WITHDRAWAL_REQUEST_STATUS_READY = 1;
  // Request has been processed
  WITHDRAWAL_REQUEST_STATUS_PROCESSED = 2;
  // Request was cancelled by user
  WITHDRAWAL_REQUEST_STATUS_CANCELLED = 3;
  // Request expired without processing
  WITHDRAWAL_REQUEST_STATUS_EXPIRED = 4;
}

// VaultState represents the current state of a V2 vault
message VaultState {
  // Total deposits in the vault
  string total_deposits = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total accrued yield
  string total_accrued_yield = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total Net Asset Value (deposits + yield)
  string total_nav = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total number of users with positions
  uint64 total_users = 4;

  // Whether deposits are currently enabled
  bool deposits_enabled = 5;

  // Whether withdrawals are currently enabled
  bool withdrawals_enabled = 6;

  // Last NAV update timestamp
  google.protobuf.Timestamp last_nav_update = 7 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Total deposit amount pending withdrawal
  string total_deposit_pending_withdrawal = 8 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Number of pending withdrawal requests
  int32 pending_withdrawal_requests = 9;

  // Total number of positions (since users can have multiple positions)
  uint64 total_positions = 10;

  // Total deposits that are eligible to receive yield (receive_yield=true, excluding pending withdrawals)
  // This is tracked incrementally and recalculated at accounting completion for accuracy
  string total_eligible_deposits = 11 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total yield amount pending withdrawal
  string total_yield_pending_withdrawal = 12 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total pending withdrawal (deposit + yield)
  string total_pending_withdrawal = 13 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// YieldCalculation contains details about yield calculations
message YieldCalculation {
  // Total deposits used in calculation
  string total_deposits = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total accrued yield
  string total_yield = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Yield rate (APY percentage)
  string yield_rate = 3 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Calculation timestamp
  google.protobuf.Timestamp calculation_time = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}

// DepositResult contains the outcome of a deposit operation
message DepositResult {
  // Amount deposited
  string amount_deposited = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// WithdrawalResult contains the outcome of a withdrawal operation
message WithdrawalResult {
  // Principal withdrawn
  string principal_withdrawn = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Yield withdrawn
  string yield_withdrawn = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Fees paid
  string fees_paid = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Total amount received (principal + yield - fees)
  string total_amount_received = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// YieldDistribution represents yield distribution to shareholders
message YieldDistribution {
  // Total yield amount distributed
  string total_yield = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Yield rate applied
  string yield_rate = 2 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Distribution timestamp
  google.protobuf.Timestamp distribution_time = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Number of eligible depositors
  uint64 eligible_depositors = 4;
}

// DepositLimit defines deposit limits and risk controls
message DepositLimit {
  // Maximum deposit amount per user per time window
  string max_user_deposit_per_window = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Maximum deposit volume per block
  string max_block_deposit_volume = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Global maximum total deposits (vault capacity)
  string global_deposit_cap = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Cooldown period in blocks between deposits
  int64 deposit_cooldown_blocks = 4;

  // Time window for velocity tracking (in blocks)
  int64 velocity_window_blocks = 5;

  // Maximum number of deposits per user in time window
  uint32 max_deposits_per_window = 6;
}

// DepositVelocity tracks user deposit velocity for risk monitoring
message DepositVelocity {
  // Block height of last deposit
  int64 last_deposit_block = 1;

  // Number of deposits in recent time window
  uint32 recent_deposit_count = 2;

  // Total volume deposited in recent time window
  string recent_deposit_volume = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Time window size in blocks
  int64 time_window_blocks = 4;
}

// TWAPConfig configures Time-Weighted Average Price for share pricing
message TWAPConfig {
  // Whether TWAP is enabled for share pricing
  bool enabled = 1;

  // Number of historical NAV snapshots to include in TWAP calculation
  uint32 window_size = 2;

  // Minimum time between NAV snapshots (in seconds)
  int64 min_snapshot_interval = 3;

  // Maximum age of snapshots to include (in seconds)
  int64 max_snapshot_age = 4;
}

// NAVSnapshot represents a point-in-time NAV observation for TWAP
message NAVSnapshot {
  // NAV value at this snapshot
  string nav = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Block height at this snapshot
  int64 block_height = 2;

  // Total shares at this snapshot (for reference)
  string total_shares = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// AccountingCursor tracks progress of yield accounting operations
message AccountingCursor {
  // Last user address that was processed
  string last_processed_user = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // NAV value being applied in this accounting session
  string accounting_nav = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Timestamp of NAV being applied
  google.protobuf.Timestamp accounting_nav_timestamp = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Number of positions processed in this accounting session
  uint64 positions_processed = 4;

  // Total positions to process in this session
  uint64 total_positions = 5;

  // Whether accounting is currently in progress
  bool in_progress = 6;

  // Timestamp when accounting started
  google.protobuf.Timestamp started_at = 7 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Accumulated residual from division precision handling
  string accumulated_residual = 8 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}
