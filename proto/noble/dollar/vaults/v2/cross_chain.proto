syntax = "proto3";

package noble.dollar.vaults.v2;

import "amino/amino.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/timestamp.proto";
import "hyperlane/warp/v1/types.proto";

option go_package = "dollar.noble.xyz/v3/types/vaults/v2";

// CrossChainRoute defines a route for cross-chain operations
// Currently supports Hyperlane, with potential for future IBC support
message CrossChainRoute {
  // HypToken
  string hyptoken_id = 1 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];
  // Reciever chain hook;
  string receiver_chain_hook = 2 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];
  // Vault
  string remote_position_address = 3 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];
  // Maximum value allowed inflight on this route
  string max_inflight_value = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// RemotePosition represents a position in an ERC-4626 compatible vault on another chain
message RemotePosition {
  // Remote Position ID
  uint64 id = 1;

  // HypToken
  string hyptoken_id = 2 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];
  // Address of the ERC-4626 compatible vault
  bytes vault_address = 3 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];

  // Number of vault shares held
  string shares_held = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Principal amount initially deposited (in USDN)
  string principal = 5 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Current share price from oracle
  string share_price = 6 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Total value of position (shares * price)
  string total_value = 7 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Last oracle update timestamp
  google.protobuf.Timestamp last_update = 8 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Oracle configuration for this position
  string oracle_address = 10;
  // Maximum staleness for oracle data (seconds)
  int64 max_staleness = 11;
}

// InflightFund represents funds in transit between Noble and remote positions
message InflightFund {
  // Unique identifier for this inflight transaction
  uint64 id = 1;

  // Id of the corresponding RemotePosition
  uint64 remote_position_id = 2;

  // Direction of funds (outgoing to remote or incoming to vault)
  InflightDirection direction = 3;

  // Amount in USDN (always USDN, never shares)
  string amount = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
 
  // When the operation was initiated
  google.protobuf.Timestamp initiated_at = 9 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Expected completion time
  google.protobuf.Timestamp expected_at = 10 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Current status
  InflightStatus status = 11;

  // Value at initiation (for AUM calculation)
  string value_at_initiation = 12 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  HyperlaneTrackingInfo hyperlane_tracking_info = 13;
}

// OperationType represents the type of cross-chain operation
enum OperationType {
  option (gogoproto.goproto_enum_prefix) = false;

  // Deposit operation
  OPERATION_TYPE_DEPOSIT = 0;
  // Withdrawal operation
  OPERATION_TYPE_WITHDRAWAL = 1;
}

// InflightDirection represents the direction of funds in transit
enum InflightDirection {
  option (gogoproto.goproto_enum_prefix) = false;

  // Funds leaving vault (deploying to remote position)
  INFLIGHT_OUTGOING = 0;
  // Funds returning to vault (withdrawing from remote position)
  INFLIGHT_INCOMING = 1;
}

// HyperlaneTrackingInfo contains Hyperlane-specific tracking data
message HyperlaneTrackingInfo {
  // Hyperlane message ID
  bytes message_id = 1;
  // Origin domain
  uint32 origin_domain = 2;
  // Destination domain
  uint32 destination_domain = 3;
  // Transaction hash on origin chain
  string origin_tx_hash = 5;
  // Transaction hash on destination chain
  string destination_tx_hash = 6;
  // Whether message has been processed
  bool processed = 7;
}

// InflightStatus represents the status of inflight funds
enum InflightStatus {
  option (gogoproto.goproto_enum_prefix) = false;

  // Transaction is pending
  INFLIGHT_PENDING = 0;
  // Transaction completed successfully
  INFLIGHT_COMPLETED = 1;
  // Transaction failed
  INFLIGHT_FAILED = 2;
  // Transaction timed out
  INFLIGHT_TIMEOUT = 3;
}

// CrossChainPositionSnapshot provides a snapshot of all cross-chain positions
message CrossChainPositionSnapshot {
  // Total value of all remote positions
  string total_remote_value = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Total value of inflight funds
  string total_inflight_value = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Number of active remote positions
  int64 active_positions = 3;
  // Number of positions with stale data
  int64 stale_positions = 4;
  // Snapshot block height
  int64 block_height = 5;
  // Breakdown by route
  map<uint32, string> value_by_route = 6;
}
