syntax = "proto3";

package noble.dollar.vaults.v2;

import "amino/amino.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/timestamp.proto";

option go_package = "dollar.noble.xyz/v2/types/vaults/v2";

// CrossChainRoute defines a route for cross-chain operations
// Currently supports Hyperlane, with potential for future IBC support
message CrossChainRoute {
  // Unique identifier for the route
  uint32 route_id = 1;
  // Source chain identifier (Hyperlane domain ID or IBC chain ID)
  string source_chain = 2;
  // Destination chain identifier (Hyperlane domain ID or IBC chain ID)
  string destination_chain = 3;
  // Provider-specific configuration
  oneof provider_config {
    // Hyperlane configuration (currently only supported provider)
    HyperlaneConfig hyperlane_config = 4;
    // Future: IBC configuration could be added here
  }
  // Whether this route is active
  bool active = 5;
  // Maximum value allowed inflight on this route
  string max_inflight_value = 6 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Risk parameters for this route
  CrossChainRiskParams risk_params = 7;
}

// HyperlaneConfig defines Hyperlane-specific configuration
message HyperlaneConfig {
  // Source Hyperlane domain ID
  uint32 source_domain = 1;
  // Destination Hyperlane domain ID
  uint32 destination_domain = 2;
  // Hyperlane mailbox address
  string mailbox_address = 3;
  // Interchain gas paymaster address
  string gas_paymaster_address = 4;
  // Hook contract address (optional)
  string hook_address = 5;
  // Gas limit for remote execution
  uint64 gas_limit = 6;
  // Expected time for message delivery (seconds)
  uint64 expected_delivery_time = 7;
}

// CrossChainRiskParams defines risk management parameters for cross-chain operations
message CrossChainRiskParams {
  // Maximum drift allowed before position revaluation (basis points)
  int32 max_drift_threshold = 1;
  // Timeout for cross-chain operations (seconds)
  int64 operation_timeout = 2;
  // Maximum number of retries for failed operations
  int32 max_retries = 3;
  // Conservative valuation discount (basis points)
  int32 conservative_discount = 4;
}

// RemotePosition represents a position in an ERC-4626 compatible vault on another chain
message RemotePosition {
  // Unique position identifier
  uint64 position_id = 1;
  // Address of the ERC-4626 compatible vault
  bytes vault_address = 2;
  // Chain identifier (Hyperlane domain ID)
  uint32 chain_id = 3;
  // Number of vault shares held
  string shares_held = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Principal amount initially deposited (in USDN)
  string principal = 5 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Current share price from oracle
  string share_price = 6 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Total value of position (shares * price)
  string total_value = 7 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Last oracle update timestamp
  google.protobuf.Timestamp last_update = 8 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Position status
  RemotePositionStatus status = 9;
  // Oracle configuration for this position
  string oracle_address = 10;
  // Maximum staleness for oracle data (seconds)
  int64 max_staleness = 11;
}

// RemotePositionStatus represents the status of a remote position
enum RemotePositionStatus {
  option (gogoproto.goproto_enum_prefix) = false;

  // Position is active and being tracked
  REMOTE_POSITION_ACTIVE = 0;
  // Position is being withdrawn from
  REMOTE_POSITION_WITHDRAWING = 1;
  // Position has been closed
  REMOTE_POSITION_CLOSED = 2;
  // Position is in error state
  REMOTE_POSITION_ERROR = 3;
}

// InflightFund represents funds in transit between Noble and remote positions
message InflightFund {
  // Cross-chain route identifier
  uint32 route_id = 1;
  // Transaction ID (Hyperlane message ID or IBC packet sequence)
  string transaction_id = 2;
  // Type of inflight operation
  InflightType type = 3;
  // Amount in USDN
  string amount = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Source chain identifier
  string source_chain = 5;
  // Destination chain identifier
  string destination_chain = 6;
  // Source position ID (optional)
  uint64 source_position_id = 7;
  // Destination position ID (optional)
  uint64 destination_position_id = 8;
  // When the operation was initiated
  google.protobuf.Timestamp initiated_at = 9 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Expected completion time
  google.protobuf.Timestamp expected_at = 10 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Current status
  InflightStatus status = 11;
  // Value at initiation (for NAV calculation)
  string value_at_initiation = 12 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Number of retry attempts
  int32 retry_count = 13;
  // Provider-specific tracking information
  ProviderTrackingInfo provider_tracking = 14;
}

// ProviderTrackingInfo contains provider-specific tracking data
message ProviderTrackingInfo {
  oneof tracking_info {
    // Hyperlane-specific tracking information
    HyperlaneTrackingInfo hyperlane_tracking = 1;
    // Future: IBC tracking could be added here
  }
}

// HyperlaneTrackingInfo contains Hyperlane-specific tracking data
message HyperlaneTrackingInfo {
  // Hyperlane message ID
  bytes message_id = 1;
  // Origin domain
  uint32 origin_domain = 2;
  // Destination domain
  uint32 destination_domain = 3;
  // Message nonce
  uint64 nonce = 4;
  // Transaction hash on origin chain
  string origin_tx_hash = 5;
  // Transaction hash on destination chain
  string destination_tx_hash = 6;
  // Whether message has been processed
  bool processed = 7;
}

// InflightType defines the type of inflight funds
enum InflightType {
  option (gogoproto.goproto_enum_prefix) = false;

  // USDN being deployed to a remote position
  INFLIGHT_DEPOSIT_TO_POSITION = 0;
  // USDN returning from a remote position
  INFLIGHT_WITHDRAWAL_FROM_POSITION = 1;
  // USDN moving between positions (via Noble)
  INFLIGHT_REBALANCE_BETWEEN_POSITIONS = 2;
  // USDN awaiting deployment to positions
  INFLIGHT_PENDING_DEPLOYMENT = 3;
  // USDN awaiting distribution to withdrawal queue
  INFLIGHT_PENDING_WITHDRAWAL_DISTRIBUTION = 4;
}

// InflightStatus represents the status of inflight funds
enum InflightStatus {
  option (gogoproto.goproto_enum_prefix) = false;

  // Transaction is pending
  INFLIGHT_PENDING = 0;
  // Transaction is confirmed by provider
  INFLIGHT_CONFIRMED = 1;
  // Transaction completed successfully
  INFLIGHT_COMPLETED = 2;
  // Transaction failed
  INFLIGHT_FAILED = 3;
  // Transaction timed out
  INFLIGHT_TIMEOUT = 4;
}

// NAVOracleUpdate represents an oracle price update received via cross-chain messaging
message NAVOracleUpdate {
  // Position identifier this update is for
  string position_id = 1;
  // Current share price
  string share_price = 2 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Number of shares held
  string shares_held = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Timestamp of the update
  google.protobuf.Timestamp timestamp = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Source chain identifier
  string source_chain = 5;
  // Message ID (Hyperlane message ID or IBC packet)
  string message_id = 6;
  // Update status
  OracleUpdateStatus status = 7;
}

// OracleUpdateStatus represents the status of an oracle update
enum OracleUpdateStatus {
  option (gogoproto.goproto_enum_prefix) = false;

  // Update has been validated
  ORACLE_UPDATE_VALIDATED = 0;
  // Update has been applied to position
  ORACLE_UPDATE_APPLIED = 1;
  // Update was rejected (stale, invalid, etc.)
  ORACLE_UPDATE_REJECTED = 2;
}

// PositionOracleConfig stores oracle configuration for a position
message PositionOracleConfig {
  // Unique position identifier
  string position_id = 1;
  // Expected origin mailbox/channel
  string origin_identifier = 2;
  // Maximum age before data is considered stale (seconds)
  int64 max_staleness = 3;
  // Authorized oracle contract address on remote chain
  string oracle_contract = 4;
  // Source chain identifier
  string source_chain = 5;
  // Last update timestamp
  google.protobuf.Timestamp last_update = 6 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Provider type (HYPERLANE, future: IBC)
  string provider_type = 7;
}

// CrossChainPositionSnapshot provides a snapshot of all cross-chain positions
message CrossChainPositionSnapshot {
  // Total value of all remote positions
  string total_remote_value = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Total value of inflight funds
  string total_inflight_value = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Number of active remote positions
  int64 active_positions = 3;
  // Number of positions with stale data
  int64 stale_positions = 4;
  // Snapshot timestamp
  google.protobuf.Timestamp timestamp = 5 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Total shares across all positions
  string total_shares = 6 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Breakdown by route
  map<uint32, string> value_by_route = 7;
}

// CrossChainConfig defines global configuration for cross-chain operations
message CrossChainConfig {
  // Maximum total remote position value as percentage of vault (basis points)
  int32 max_remote_exposure = 1;
  // Default operation timeout (seconds)
  int64 default_timeout = 2;
  // Position update frequency (seconds)
  int64 update_frequency = 3;
  // Maximum number of remote positions
  uint32 max_remote_positions = 4;
  // Allowed chains (can be Hyperlane domains or IBC chain IDs)
  repeated string allowed_chains = 5;
  // Whether cross-chain operations are enabled
  bool enabled = 6;
  // Maximum duration funds can be inflight (seconds)
  int64 max_inflight_duration = 7;
  // Maximum total value allowed inflight
  string max_inflight_value = 8 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
  // Supported providers (currently only HYPERLANE)
  repeated string supported_providers = 9;
}

// StaleInflightAlert represents an alert for inflight funds exceeding expected duration
message StaleInflightAlert {
  // Route ID
  uint32 route_id = 1;
  // Transaction ID
  string transaction_id = 2;
  // Hours overdue
  double hours_overdue = 3;
  // Alert timestamp
  google.protobuf.Timestamp timestamp = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
  // Recommended action
  string recommended_action = 5;
  // Amount stuck in transit
  string amount = 6 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}
