syntax = "proto3";

package noble.dollar.vaults.v2;

import "amino/amino.proto";
import "cosmos/msg/v1/msg.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/timestamp.proto";
import "noble/dollar/vaults/v2/cross_chain.proto";

option go_package = "dollar.noble.xyz/v3/types/vaults/v2";

// ========== Oracle Types ==========

// RemotePosition represents a position tracked by an oracle
message RemotePositionOracle {
  // Unique position identifier
  uint64 position_id = 1;

  // Chain ID where the position exists
  uint32 chain_id = 2;

  // Oracle contract address on the remote chain
  string oracle_address = 3 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];

  // Vault address holding this position
  string vault_address = 4;

  // Number of shares held
  string shares_held = 5 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Current share price
  string share_price = 6 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Last update timestamp
  google.protobuf.Timestamp last_update = 7 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}

// EnrolledOracle represents a registered oracle
message EnrolledOracle {
  // Position identifier
  uint64 position_id = 1;

  // Source chain identifier
  string source_chain = 2;

  // Oracle address on remote chain
  string oracle_address = 3 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];

  // Maximum staleness (seconds)
  int64 max_staleness = 4;

  // Registration timestamp
  google.protobuf.Timestamp registered_at = 5 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Whether the oracle is active
  bool active = 6;
}

// OracleGovernanceParams defines governance parameters for oracles
message OracleGovernanceParams {
  // Maximum update interval allowed (seconds)
  int64 max_update_interval = 1;

  // Minimum update interval to prevent spam (seconds)
  int64 min_update_interval = 2;

  // Maximum price deviation per update (basis points)
  int32 max_price_deviation_bps = 3;
}

// ========== Messages ==========

// MsgRegisterOracle registers a new oracle for a position
message MsgRegisterOracle {
  option (cosmos.msg.v1.signer) = "authority";
  option (amino.name) = "dollar/vaults/v2/RegisterOracle";

  option (gogoproto.equal) = false;
  option (gogoproto.goproto_getters) = false;

  // Authority (governance module account)
  string authority = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Position identifier to track
  uint64 position_id = 2;

  // Oracle contract address on remote chain
  string oracle_address = 3 [
    (gogoproto.customtype) = "github.com/bcp-innovations/hyperlane-cosmos/util.HexAddress",
    (gogoproto.nullable) = false
  ];

  // Source chain identifier
  string source_chain = 4;

  // Maximum staleness allowed (seconds)
  int64 max_staleness = 5;

  // Origin identifier (mailbox for Hyperlane, channel for IBC)
  string origin_identifier = 7;
}

// MsgRegisterOracleResponse confirms oracle registration
message MsgRegisterOracleResponse {
  // Oracle ID assigned
  string oracle_id = 1;

  // Position ID
  uint64 position_id = 2;

  // Registration timestamp
  google.protobuf.Timestamp registered_at = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}

// MsgUpdateOracleConfig updates an oracle's configuration
message MsgUpdateOracleConfig {
  option (cosmos.msg.v1.signer) = "authority";
  option (amino.name) = "dollar/vaults/v2/UpdateOracleConfig";

  option (gogoproto.equal) = false;
  option (gogoproto.goproto_getters) = false;

  // Authority (governance module account)
  string authority = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Oracle ID to update
  string oracle_id = 2;

  // New maximum staleness (0 to keep current)
  int64 max_staleness = 3;

  // Whether to activate/deactivate
  bool active = 4;
}

// MsgUpdateOracleConfigResponse confirms configuration update
message MsgUpdateOracleConfigResponse {
  // Oracle ID
  string oracle_id = 1;

  // Updated configuration
  EnrolledOracle updated_config = 2;
}

// MsgRemoveOracle removes an oracle from the system
message MsgRemoveOracle {
  option (cosmos.msg.v1.signer) = "authority";
  option (amino.name) = "dollar/vaults/v2/RemoveOracle";

  option (gogoproto.equal) = false;
  option (gogoproto.goproto_getters) = false;

  // Authority (governance module account)
  string authority = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Oracle ID to remove
  string oracle_id = 2;

  // Reason for removal
  string reason = 3;
}

// MsgRemoveOracleResponse confirms oracle removal
message MsgRemoveOracleResponse {
  // Oracle ID removed
  string oracle_id = 1;

  // Position ID affected
  uint64 position_id = 2;

  // Removal timestamp
  google.protobuf.Timestamp removed_at = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}

// MsgUpdateOracleParams updates global oracle parameters
message MsgUpdateOracleParams {
  option (cosmos.msg.v1.signer) = "authority";
  option (amino.name) = "dollar/vaults/v2/UpdateOracleParams";

  option (gogoproto.equal) = false;
  option (gogoproto.goproto_getters) = false;

  // Authority (governance module account)
  string authority = 1 [(cosmos_proto.scalar) = "cosmos.AddressString"];

  // Updated governance parameters
  OracleGovernanceParams params = 2 [(gogoproto.nullable) = false];
}

// MsgUpdateOracleParamsResponse confirms parameter update
message MsgUpdateOracleParamsResponse {
  // Previous parameters
  OracleGovernanceParams previous_params = 1 [(gogoproto.nullable) = false];

  // New parameters
  OracleGovernanceParams new_params = 2 [(gogoproto.nullable) = false];
}
