syntax = "proto3";

package noble.dollar.vaults.v2;

import "amino/amino.proto";
import "cosmos_proto/cosmos.proto";
import "gogoproto/gogo.proto";
import "google/protobuf/timestamp.proto";

option go_package = "dollar.noble.xyz/v3/types/vaults/v2";

// AUMBand defines the pricing bands for deposits and withdrawals
message AUMBand {
  // Lower bound of the band (basis points above/below AUM)
  int32 lower_bound = 1;
  // Upper bound of the band (basis points above/below AUM)
  int32 upper_bound = 2;
}

// AUMConfig defines the configuration for AUM-based pricing
message AUMConfig {
  // Base AUM bands for deposits
  repeated AUMBand deposit_bands = 1;
  // Base AUM bands for withdrawals
  repeated AUMBand withdrawal_bands = 2;
  // Minimum AUM update interval (seconds)
  int64 min_aum_update_interval = 3;
  // Maximum allowed AUM deviation before emergency controls (basis points)
  int32 max_aum_deviation = 4;
  // Emergency circuit breaker threshold (basis points)
  int32 circuit_breaker_threshold = 5;
}

// AUMInfo represents current AUM information for a vault
message AUMInfo {
  // Current AUM value
  string current_aum = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Previous AUM value
  string previous_aum = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Last update timestamp
  google.protobuf.Timestamp last_update = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}

// CircuitBreakerTrip records when a circuit breaker was triggered
message CircuitBreakerTrip {
  // AUM change that triggered the circuit breaker (basis points)
  int32 change_bps = 1;

  // Remote position ID that caused the circuit breaker to trigger
  uint64 remote_position_id = 2;

  // Timestamp when circuit breaker was triggered
  google.protobuf.Timestamp triggered_at = 3 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Previous AUM before the change
  string previous_aum = 4 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Attempted new AUM that triggered the breaker
  string attempted_aum = 5 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];
}

// AUMUpdate represents a AUM update event
message AUMUpdate {
  // New AUM point
  string new_aum = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Update timestamp
  google.protobuf.Timestamp timestamp = 2 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];

  // Block height
  int64 block_height = 3;
}

// PricingInfo provides pricing information for deposits/withdrawals
message PricingInfo {
  // Current yield rate (APY)
  string yield_rate = 1 [
    (cosmos_proto.scalar) = "cosmos.Dec",
    (gogoproto.customtype) = "cosmossdk.io/math.LegacyDec",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Applied AUM band
  AUMBand applied_band = 2;

  // Effective fee rate
  int32 effective_fee_rate = 3;
}

// LossEvent represents a loss in vault value
message LossEvent {
  // Amount of loss
  string loss_amount = 1 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Previous AUM before loss
  string previous_aum = 2 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // New AUM after loss
  string new_aum = 3 [
    (cosmos_proto.scalar) = "cosmos.Int",
    (gogoproto.customtype) = "cosmossdk.io/math.Int",
    (gogoproto.nullable) = false,
    (amino.dont_omitempty) = true
  ];

  // Timestamp of loss
  google.protobuf.Timestamp timestamp = 4 [
    (gogoproto.nullable) = false,
    (gogoproto.stdtime) = true
  ];
}
